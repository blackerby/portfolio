<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="(meta)data(sette) # Intro # After running cleanup.sh I like to make a local copy of it as a tab-separated file I can do various things with, including storing it in SQLite database with Datasette which, among other things, allows me to link the metadata with their associated text files.
The Code # As usual, it&rsquo;s a shell script.
#!/usr/bin/env zsh I use wget to save the data to my local machine."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="6. (meta)data(sette)"><meta property="og:description" content="(meta)data(sette) # Intro # After running cleanup.sh I like to make a local copy of it as a tab-separated file I can do various things with, including storing it in SQLite database with Datasette which, among other things, allows me to link the metadata with their associated text files.
The Code # As usual, it&rsquo;s a shell script.
#!/usr/bin/env zsh I use wget to save the data to my local machine."><meta property="og:type" content="article"><meta property="og:url" content="https://blackerby.github.io/portfolio/docs/technology/metadata/2022-12-04-meta-data-sette/"><meta property="article:section" content="docs"><title>6. (meta)data(sette) | Blackerby Portfolio</title><link rel=manifest href=/portfolio/manifest.json><link rel=icon href=/portfolio/favicon.png type=image/x-icon><link rel=stylesheet href=/portfolio/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/portfolio/flexsearch.min.js></script>
<script defer src=/portfolio/en.search.min.a8a4de6e6109bef005eb9dec02cb32e3190319541c43773c37a59bec285ff39d.js integrity="sha256-qKTebmEJvvAF653sAssy4xkDGVQcQ3c8N6Wb7Chf850=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/portfolio/><span>Blackerby Portfolio</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-426f539af5864fc342d2765a8b0cfb21 class=toggle>
<label for=section-426f539af5864fc342d2765a8b0cfb21 class="flex justify-between"><a href=/portfolio/docs/outcomes/>Outcomes</a></label><ul><li><a href=/portfolio/docs/outcomes/articulate/>Articulate</a><ul></ul></li><li><a href=/portfolio/docs/outcomes/evaluate/>Evaluate</a><ul></ul></li><li><a href=/portfolio/docs/outcomes/practice/>Practice</a><ul></ul></li><li><a href=/portfolio/docs/outcomes/use/>Use</a><ul></ul></li></ul></li><li><a href=/portfolio/docs/philosophy/>Philosophy</a></li><li><a href=/portfolio/docs/resume/>Resume</a></li><li><input type=checkbox id=section-39dce656b4d24db3501949b7edf5cb43 class=toggle checked>
<label for=section-39dce656b4d24db3501949b7edf5cb43 class="flex justify-between"><a role=button>Technology</a></label><ul><li><input type=checkbox id=section-6489aba0bc74aaff9b095a3c6e1e7697 class=toggle checked>
<label for=section-6489aba0bc74aaff9b095a3c6e1e7697 class="flex justify-between"><a role=button>Metadata Workflow Series</a></label><ul><li><a href=/portfolio/docs/technology/metadata/2022-11-22-llc-workflow/>1. A High Level Metadata Workflow Overview</a></li><li><a href=/portfolio/docs/technology/metadata/2022-11-23-prep/>2. prep.sh and mlr</a></li><li><a href=/portfolio/docs/technology/metadata/2022-11-24-get-summaries/>3. get_summaries.py</a></li><li><a href=/portfolio/docs/technology/metadata/2022-11-25-emacs-workflow/>4. Emacs Workflow</a></li><li><a href=/portfolio/docs/technology/metadata/2022-11-25-cleanup/>5. cleanup.sh</a></li><li><a href=/portfolio/docs/technology/metadata/2022-12-04-meta-data-sette/ class=active>6. (meta)data(sette)</a></li></ul></li><li><a href=/portfolio/docs/technology/topic-modeling/>Visualizing Topics of 74th Congress Senate Bills and Joint Resolutions</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/portfolio/svg/menu.svg class=book-icon alt=Menu></label>
<strong>6. (meta)data(sette)</strong>
<label for=toc-control><img src=/portfolio/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#the-code>The Code</a><ul><li><a href=#the-database>The Database</a></li><li><a href=#local-copies-of-the-data>Local Copies of the Data</a></li></ul></li><li><a href=#next-time>Next Time</a></li></ul></nav></aside></header><article class=markdown><h1 id=metadatasette>(meta)data(sette)
<a class=anchor href=#metadatasette>#</a></h1><h2 id=intro>Intro
<a class=anchor href=#intro>#</a></h2><p>After running <a href=https://blackerby.github.io/2022/11/25/cleanup.html>cleanup.sh</a> I like to make a local copy of it as a tab-separated file I can do various things with, including storing it in SQLite database with <a href=https://datasette.io/>Datasette</a> which, among other things, allows me to link the metadata with their associated text files.</p><h2 id=the-code>The Code
<a class=anchor href=#the-code>#</a></h2><p>As usual, it&rsquo;s a shell script.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env zsh
</span></span></span></code></pre></div><p>I use <a href=https://www.gnu.org/software/wget/>wget</a> to save the data to my local machine. Getting the URL right took a little Googling and turned up this great answer on <a href=https://stackoverflow.com/a/28494469>Stack Overflow</a>. The spreadsheet has to be published to the web in order for this to work.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>wget -q -O ./all_data.tsv https://docs.google.com/spreadsheets/d/e/2PACX-1vQkoFBuqjcBX-a_xT3IfTmLmUJ0LZme8Mj16sIdqqEC9Z_vPmyHJKiTCRrZHPaSsxI-4lKaLkWD_XSk/pub<span style=color:#ae81ff>\?</span>gid<span style=color:#ae81ff>\=</span>0<span style=color:#ae81ff>\&amp;</span>single<span style=color:#ae81ff>\=</span>true<span style=color:#ae81ff>\&amp;</span>output<span style=color:#ae81ff>\=</span>tsv
</span></span></code></pre></div><h3 id=the-database>The Database
<a class=anchor href=#the-database>#</a></h3><p>I then (re)create the SQLite database containing the bill metadata and the summary text files using Simon Willison&rsquo;s extraordinarily easy to use <a href=https://sqlite-utils.datasette.io/en/stable/>sqlite-utils</a>.</p><p>First, I drop the existing tables that hold the core data.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>sqlite-utils drop-table summaries.db actions
</span></span><span style=display:flex><span>sqlite-utils drop-table summaries.db files
</span></span></code></pre></div><p>Then I recreate the <code>actions</code> table, which is the table that holds the bill metadata</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>sqlite-utils insert summaries.db actions all_data.tsv --tsv -d
</span></span></code></pre></div><p>I rename the columns for from the spreadsheet for use in the database. There may be a better way to do this, but this works.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>sqlite-utils transform summaries.db actions --rename <span style=color:#e6db74>&#34;Congress&#34;</span> <span style=color:#e6db74>&#34;congress&#34;</span> --rename <span style=color:#e6db74>&#34;Session&#34;</span> <span style=color:#e6db74>&#34;session&#34;</span> --rename <span style=color:#e6db74>&#34;PL Num (if applicable)/PVTL Num&#34;</span> <span style=color:#e6db74>&#34;pl_num&#34;</span> --rename <span style=color:#e6db74>&#34;Bill Type&#34;</span> <span style=color:#e6db74>&#34;bill_type&#34;</span> --rename <span style=color:#e6db74>&#34;Bill Number &#34;</span> <span style=color:#e6db74>&#34;bill_number&#34;</span> --rename <span style=color:#e6db74>&#34;Sponsor&#34;</span> <span style=color:#e6db74>&#34;sponsor&#34;</span> --rename <span style=color:#e6db74>&#34;Committee&#34;</span> <span style=color:#e6db74>&#34;committee&#34;</span> --drop <span style=color:#e6db74>&#34;Action Code&#34;</span> --drop <span style=color:#e6db74>&#34;Summary Version Code&#34;</span> --drop <span style=color:#e6db74>&#34;Report Number&#34;</span> --rename <span style=color:#e6db74>&#34;Action&#34;</span> <span style=color:#e6db74>&#34;action&#34;</span> --rename <span style=color:#e6db74>&#34;Action Date&#34;</span> <span style=color:#e6db74>&#34;action_date&#34;</span> --rename <span style=color:#e6db74>&#34;Associated Summary Text File Name&#34;</span> <span style=color:#e6db74>&#34;summary_text_file_name&#34;</span> --rename <span style=color:#e6db74>&#34;Questions/Comments&#34;</span> <span style=color:#e6db74>&#34;questions_comments&#34;</span>
</span></span></code></pre></div><p>Now I insert all the text file summaries on my local machine into the database.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>sqlite-utils insert-files --text summaries.db files 74*/*.txt
</span></span></code></pre></div><p>This ends up saving the directory name and file name in the <code>files</code> tables&rsquo;s <code>path</code> column. We just want the file name since that&rsquo;s what is recorded in the <code>actions</code> table. The following fixes that for us.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>sqlite-utils convert summaries.db files path <span style=color:#e6db74>&#39;value.split(&#34;/&#34;)[1]&#39;</span>
</span></span></code></pre></div><p>Now we can link up the two tables</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>sqlite-utils add-foreign-key summaries.db actions summary_text_file_name files path --ignore
</span></span></code></pre></div><p>and publish the database as an app on Heroku.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>datasette publish heroku summaries.db --name <span style=color:#e6db74>&#34;llc&#34;</span> --tar <span style=color:#e6db74>&#34;/usr/local/bin/gtar&#34;</span> --install<span style=color:#f92672>=</span>datasette-saved-queries
</span></span></code></pre></div><h3 id=local-copies-of-the-data>Local Copies of the Data
<a class=anchor href=#local-copies-of-the-data>#</a></h3><p>Next I massage the data a little bit to allow for some simple analysis on the command line with <a href=https://miller.readthedocs.io>MIller</a>. The <code>awk</code> command drops the columns that don&rsquo;t have any data in them and the Miller command fills empty spots in the <code>Sponsor</code> and <code>Committee</code> columns, making the data bit <a href=https://vita.had.co.nz/papers/tidy-data.pdf>tidy</a>-er.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span>awk <span style=color:#e6db74>&#39;BEGIN{FS=OFS=&#34;\t&#34;}{print $1, $2, $4, $5, $6, $7, $11, $12}&#39;</span> all_data.tsv | mlr --tsv fill-down -f Sponsor,Committee <span style=color:#66d9ef>then</span> cat &gt; filled_metadata.tsv
</span></span></code></pre></div><p>Finally, to allow for easier reading of the spreadsheet by humans, the following awk command puts a blank line between each bill. <code>$5</code> refers to the <code>Bill Number</code> column.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#75715e># insert blank lines between bills for pasting into final spreadsheet</span>
</span></span><span style=display:flex><span>awk <span style=color:#e6db74>&#39;BEGIN{FS=&#34;\t&#34;} {cur=$5} NR&gt;1 &amp;&amp; cur!=prev {print &#34;&#34;} {prev=cur; print}&#39;</span> all_data.tsv &gt; spaced_metadata.tsv
</span></span></code></pre></div><h2 id=next-time>Next Time
<a class=anchor href=#next-time>#</a></h2><p>This wraps up the core workflow, so now it&rsquo;s time to move on how I actually use the Datasette web interface and SQL queries to check metadata quality.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#the-code>The Code</a><ul><li><a href=#the-database>The Database</a></li><li><a href=#local-copies-of-the-data>Local Copies of the Data</a></li></ul></li><li><a href=#next-time>Next Time</a></li></ul></nav></div></aside></main></body></html>